# Тестовый проект

## Подготовка к работе

Для работы проекта необходимо установить пакеты:
- vagrant
- virtualbox
- ansible >= 2.10

В случае отсутствия необходимой версии в репозиториях, установить более новую версию Ansible другими способами, например с помощью pip:
```bash
$ python3 -m pip install ansible
```

Также может потребоваться установка плагина Ansible для работы с докером:
```bash
$ ansible-galaxy collection install community.docker
```

## Запуск проекта

В каталоге с Vagrantfile необходимо выполнить `vagrant up` для запуска ВМ Ubuntu 20.04.


> Стоит отметить, что при проблемах с автоматическим скачиванием образа ВМ средствами Vagrant, необходимо добавить его вручную, например:
```bash
$ wget https://app.vagrantup.com/generic/boxes/ubuntu2004/versions/4.1.18/providers/virtualbox.box
$ vagrant box add virtualbox.box --name generic/ubuntu2004
```
После добавления таким образом команда `vagrant up` будет использовать локальный образ.


## Результат и проверка работоспособности

После запуска виртуальной машины и контейнеров будет доступен веб-интерфейс Grafana по протоколу http и порту 3000, например `http://localhost:3000` локально с машины с Vagrant или по внешнему адресу компьютера. 

Логин и пароль от веб-интерфейса Grafana по умолчанию: `admin:admin`


## Структура проекта

```bash
├── grafana
│   ├── dashboards
│   │   ├── cluster.json
│   │   └── default.yaml
│   └── datasources
│       └── default.yaml
├── prometheus
│   ├── Dockerfile
│   └── prometheus.yml
├── playbook.yaml
└── Vagrantfile
```
Каталог grafana содержит файлы источников данных и настроек дашбордов например cluster.json — дашборд 1806. Файлы передаются с помощью общих каталогов ВМ и томов Docker.

Каталог prometheus содержит Dockerfile для настройки контейнера и передачи в него заготовленного файла конфигурации prometheus.yml 

Vagrantfile запускает виртуальную машину со следующими параметрами: 
- 2 ядра процессора, 
- 1,5ГБ ОЗУ, 
- внутренний адрес 192.168.56.10, 
- проброс порта 3000 для доступа к веб-интерфейсу Grafana, 

а также загружает playbook.yaml для Ansible для установки необходимых пакетов и настройки контейнеров, поэтому первый запуск может занять продолжительное время.

## Докер-контейнеры

Ansible Playbook запускает 2 контейнера:

- Prometheus для сбора метрик виртуальной машины Ubuntu 20.04: используется Dokerfile, который копирует конфигурационный файл в контейнер `prometheus`, который собирает данные по порту 9100 с `prometheus-node-exporter`, установленный на Ubuntu 20.04. Для сбора данных используется внутренний сетевой интерфейс Docker: `172.17.0.1`
- Grafana для отображения данных в веб-интерфейсе: с помощью Docker Volumes загружаются файлы настроек источников данных `datasources/default.yaml`, а также настройки Dashboard `dashboards/default.yaml` и готовый шаблон `dashboards/cluster.json` (Dashboard 1806). Также прокидывается порт 3000 для доступа к Grafana через веб-интерфейс.
